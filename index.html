<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Si-3.26 Аналитик | MOEX + DeepSeek</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://unpkg.com"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; --accent: #8957e5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; max-width: 1400px; margin: 0 auto; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        #chart { height: 550px; width: 100%; position: relative; }
        .signal-display { text-align: center; padding: 15px; border-radius: 10px; border: 2px solid var(--border); margin-bottom: 15px; }
        .buy { border-color: #238636; color: #3fb950; background: rgba(35, 134, 54, 0.1); }
        .sell { border-color: #f85149; color: #f85149; background: rgba(248, 81, 73, 0.1); }
        .hold { border-color: #8b949e; color: #8b949e; }
        input, textarea { width: 100%; padding: 10px; background: #0d1117; color: white; border: 1px solid var(--border); border-radius: 6px; margin-top: 5px; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; padding: 14px; cursor: pointer; border-radius: 6px; width: 100%; font-weight: bold; margin-top: 10px; }
        #loading-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #8b949e; }
    </style>
</head>
<body>

    <h2 style="text-align: center;">Si-3.26 (H6) Анализ тренда</h2>

    <div class="grid">
        <div class="card" id="chart">
            <div id="loading-text">Загрузка данных из системы ISS MOEX...</div>
        </div>

        <div class="side">
            <div class="card">
                <div id="signal_ui" class="signal-display hold">
                    <div style="font-size: 11px; opacity: 0.7;">ВЕРДИКТ DEEPSEEK V3</div>
                    <div id="signal_text" style="font-size: 28px; font-weight: bold;">ОЖИДАНИЕ</div>
                </div>
                <div id="ai_desc" style="font-size: 13px; color: #8b949e; min-height: 40px;">Нажмите кнопку для запуска AI-фильтрации шума.</div>
                <button onclick="analyzeWithAI()">ЗАПУСТИТЬ AI АНАЛИЗ</button>
            </div>

            <div class="card" style="margin-top: 20px;">
                <label>OpenRouter API Key:</label>
                <input type="password" id="api_key_input" placeholder="sk-or-v1-...">
                <label style="display:block; margin-top:10px;">Заметки:</label>
                <textarea id="notes_area" rows="3"></textarea>
                <button style="background: #21262d;" onclick="saveConfig()">Сохранить настройки</button>
            </div>
        </div>
    </div>

    <script>
        const TICKER = "SiH6"; 
        let historyData = [];

        // 1. ЗАГРУЗКА ДАННЫХ MOEX
        async function fetchMoexData() {
            const url = `https://iss.moex.com{TICKER}/candles.json?interval=24&from=2025-11-01`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Сетевая ошибка');
                const data = await response.json();
                
                // MOEX возвращает данные в data.candles.data
                // Структура массива: [open, close, high, low, value, volume, begin, end]
                const rawCandles = data.candles.data;
                
                historyData = rawCandles.map(c => ({
                    time: c[6].split(' ')[0], // берем дату из 'begin'
                    open: c[0],
                    high: c[2],
                    low: c[3],
                    close: c[1]
                }));

                renderChart(historyData);
                document.getElementById('loading-text').style.display = 'none';
            } catch (err) {
                console.error(err);
                document.getElementById('loading-text').innerText = "Ошибка: ISS MOEX недоступен (проверьте интернет)";
            }
        }

        // 2. ОТРИСОВКА ГРАФИКА
        function renderChart(data) {
            const chart = LightweightCharts.createChart(document.getElementById('chart'), {
                layout: { background: { color: '#161b22' }, textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#30363d' }, horzLines: { color: '#30363d' } },
            });
            const candleSeries = chart.addCandlestickSeries({
                upColor: '#238636', downColor: '#f85149', borderVisible: false,
                wickUpColor: '#238636', wickDownColor: '#f85149'
            });
            candleSeries.setData(data);
            chart.timeScale().fitContent();
        }

        // 3. AI АНАЛИЗ (DeepSeek V3)
        async function analyzeWithAI() {
            const apiKey = document.getElementById('api_key_input').value;
            if (!apiKey) return alert("Нужен API Ключ OpenRouter");

            const stext = document.getElementById('signal_text');
            const sdesc = document.getElementById('ai_desc');
            const sui = document.getElementById('signal_ui');

            stext.innerText = "РАСЧЕТ...";
            
            // Берем последние 30 дней
            const sample = historyData.slice(-30);

            try {
                const res = await fetch("https://openrouter.ai", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": "deepseek/deepseek-chat", 
                        "messages": [
                            {
                                "role": "system",
                                "content": "Ты - финансовый аналитик. Твоя цель - определить тренд SiH6, игнорируя боковой шум. Отвечай кратко."
                            },
                            {
                                "role": "user",
                                "content": `Данные OHLC: ${JSON.stringify(sample)}. Выдай вердикт (ПОКУПКА, ПРОДАЖА или ДЕРЖАТЬ) и обоснуй отсутствие шума.`
                            }
                        ]
                    })
                });

                const aiRes = await res.json();
                const answer = aiRes.choices[0].message.content.toUpperCase();

                sui.className = "signal-display";
                if (answer.includes("ПОКУПКА")) {
                    sui.classList.add("buy");
                    stext.innerText = "ПОКУПКА";
                } else if (answer.includes("ПРОДАЖА")) {
                    sui.classList.add("sell");
                    stext.innerText = "ПРОДАЖА";
                } else {
                    sui.classList.add("hold");
                    stext.innerText = "ДЕРЖАТЬ";
                }
                sdesc.innerText = aiRes.choices[0].message.content;

            } catch (e) {
                stext.innerText = "ОШИБКА";
                sdesc.innerText = "Ошибка запроса к API. Проверьте ключ.";
            }
        }

        function saveConfig() {
            localStorage.setItem('si_key', document.getElementById('api_key_input').value);
            localStorage.setItem('si_notes', document.getElementById('notes_area').value);
            alert("Настройки сохранены");
        }

        window.onload = () => {
            fetchMoexData();
            document.getElementById('api_key_input').value = localStorage.getItem('si_key') || "";
            document.getElementById('notes_area').value = localStorage.getItem('si_notes') || "";
        };
    </script>
</body>
</html>
