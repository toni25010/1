<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Si-3.26 Аналитик | Исправленная версия</title>
    <script src="https://unpkg.com"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; --accent: #8957e5; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; max-width: 1200px; margin: 0 auto; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        #chart { height: 500px; width: 100%; position: relative; }
        .signal-display { text-align: center; padding: 15px; border-radius: 10px; border: 2px solid var(--border); margin-bottom: 15px; }
        .buy { border-color: #238636; color: #3fb950; background: rgba(35, 134, 54, 0.1); }
        .sell { border-color: #f85149; color: #f85149; background: rgba(248, 81, 73, 0.1); }
        .hold { border-color: #8b949e; color: #8b949e; }
        input, textarea { width: 100%; padding: 10px; background: #0d1117; color: white; border: 1px solid var(--border); border-radius: 6px; margin-top: 5px; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; padding: 14px; cursor: pointer; border-radius: 6px; width: 100%; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <h2 style="text-align: center;">Анализ Si-3.26 (H6)</h2>

    <div class="grid">
        <div class="card" id="chart">
            <div id="loading" style="position:absolute; top:45%; left:35%;">Загрузка данных MOEX...</div>
        </div>

        <div class="side">
            <div class="card">
                <div id="signal_ui" class="signal-display hold">
                    <div style="font-size: 11px; opacity: 0.7;">DEEPSEEK V3 SIGNAL</div>
                    <div id="signal_text" style="font-size: 26px; font-weight: bold;">ОЖИДАНИЕ</div>
                </div>
                <div id="ai_desc" style="font-size: 13px; color: #8b949e;">Нажмите для AI анализа (нужен прокси или плагин CORS)</div>
                <button onclick="analyzeWithAI()">ЗАПУСТИТЬ AI АНАЛИЗ</button>
            </div>

            <div class="card" style="margin-top: 20px;">
                <label>OpenRouter API Key:</label>
                <input type="password" id="api_key_input" placeholder="sk-or-v1-...">
                <button style="background: #21262d;" onclick="saveConfig()">Сохранить настройки</button>
                <p style="font-size: 10px; color: #f85149; margin-top: 10px;">Примечание: Если AI выдает ошибку CORS, используйте расширение "Allow CORS" в Chrome.</p>
            </div>
        </div>
    </div>

    <script>
        const TICKER = "SiH6";
        let historyData = [];

        // 1. ЗАГРУЗКА ДАННЫХ MOEX (Исправлен URL и парсинг)
        async function fetchMoexData() {
            // Исправлен URL: добавлен слэш перед {TICKER}
            const url = `https://iss.moex.com{TICKER}/candles.json?interval=24&from=2025-11-01`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                // У MOEX данные лежат в data.candles.data
                // Формат: [open, close, high, low, value, volume, begin, end]
                const raw = data.candles.data;
                
                historyData = raw.map(c => ({
                    time: c[6].split(' ')[0], // Извлекаем только дату YYYY-MM-DD из столбца 'begin'
                    open: c[0],
                    high: c[2],
                    low: c[3],
                    close: c[1]
                }));

                renderChart(historyData);
                document.getElementById('loading').style.display = 'none';
            } catch (err) {
                document.getElementById('loading').innerText = "Ошибка сети или API MOEX";
                console.error("MOEX Error:", err);
            }
        }

        function renderChart(data) {
            const chart = LightweightCharts.createChart(document.getElementById('chart'), {
                layout: { background: { color: '#161b22' }, textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#30363d' }, horzLines: { color: '#30363d' } },
            });
            const series = chart.addCandlestickSeries({ upColor: '#238636', downColor: '#f85149' });
            series.setData(data);
            chart.timeScale().fitContent();
        }

        // 2. AI АНАЛИЗ (Добавлена обработка CORS)
        async function analyzeWithAI() {
            const apiKey = document.getElementById('api_key_input').value;
            if (!apiKey) return alert("Введите API Ключ");

            document.getElementById('signal_text').innerText = "АНАЛИЗ...";
            
            const lastData = historyData.slice(-25);

            try {
                const response = await fetch("https://openrouter.ai", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href, // Обязательно для OpenRouter
                        "X-Title": "Si Analyzer"
                    },
                    body: JSON.stringify({
                        "model": "deepseek/deepseek-chat",
                        "messages": [{
                            "role": "user", 
                            "content": `Инструмент SiH6. Данные: ${JSON.stringify(lastData)}. Дай сигнал: ПОКУПКА, ПРОДАЖА или ДЕРЖАТЬ. Фильтруй боковой шум.`
                        }]
                    })
                });

                const aiRes = await response.json();
                if (aiRes.error) throw new Error(aiRes.error.message);
                
                const answer = aiRes.choices[0].message.content;
                const ui = document.getElementById('signal_ui');
                const stext = document.getElementById('signal_text');

                ui.className = "signal-display";
                if (answer.toUpperCase().includes("ПОКУПКА")) { ui.classList.add("buy"); stext.innerText = "ПОКУПКА"; }
                else if (answer.toUpperCase().includes("ПРОДАЖА")) { ui.classList.add("sell"); stext.innerText = "ПРОДАЖА"; }
                else { ui.classList.add("hold"); stext.innerText = "ДЕРЖАТЬ"; }

                document.getElementById('ai_desc').innerText = answer.substring(0, 200) + "...";

            } catch (e) {
                alert("Ошибка CORS или API. Если вы на GitHub, установите расширение 'Allow CORS' в браузере или используйте прокси.");
                document.getElementById('signal_text').innerText = "ОШИБКА";
                console.error("AI Error:", e);
            }
        }

        function saveConfig() {
            localStorage.setItem('si_key', document.getElementById('api_key_input').value);
            alert("Ключ сохранен локально");
        }

        window.onload = () => {
            fetchMoexData();
            document.getElementById('api_key_input').value = localStorage.getItem('si_key') || "";
        };
    </script>
</body>
</html>
